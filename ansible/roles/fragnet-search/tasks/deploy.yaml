---

# Debug

- name: Debug
  debug:
    msg: okd_admin_password={{ okd_admin_password }} keycloak_admin_password={{ keycloak_admin_password }} neo4j_password={{ neo4j_password }}

# Create the project

- name: Login (user)
  command: oc login https://{{ okd_master_hostname }} -u {{ okd_user }} -p {{ okd_user_password }}
  changed_when: False

- name: Deploy Project
  k8s:
    definition: "{{ lookup('template', item)|from_yaml }}"
  loop:
  - project.yml.j2

# Create the service account
#
# The Fragnet Search service account needs 'anyuid'
# as its container uses tomcat

- name: Login (admin)
  command: oc login https://{{ okd_master_hostname }} -u {{ okd_admin }} -p {{ okd_admin_password }}
  changed_when: False

- name: Move to Fragnet Search Project
  command: oc project {{ fs_project }}
  changed_when: False

- name: Deploy SA
  k8s:
    definition: "{{ lookup('template', item)|from_yaml }}"
  loop:
  - service-account.yml.j2

- name: Add anyuid to SA
  command: oc adm policy add-scc-to-user anyuid -z {{ fs_sa }}

# Configure the Fragnet Search Keycloak Client

- name: Add Keycloak Fragnet Search Client
  local_action:
    module: keycloak_client
    auth_client_id: admin-cli
    auth_keycloak_url: "{{ keycloak_server_url }}"
    auth_realm: master
    auth_username: "{{ keycloak_admin }}"
    auth_password: "{{ keycloak_admin_password }}"
    realm: "{{ keycloak_realm }}"
    client_id: "{{ fs_keycloak_client_id }}"
    protocol: openid-connect
    base_url: https://{{ fs_route }}.{{ okd_route_basename }}
    public_client: yes
    service_accounts_enabled: yes
    direct_access_grants_enabled: yes
    standard_flow_enabled: yes
    default_roles:
    - fragnet-search

# Deploy the application

- name: Deploy application objects
  k8s:
    definition: "{{ lookup('template', item)|from_yaml }}"
  loop:
  - configmap.yml.j2
  - deployment.yml.j2
  - service.yml.j2

# Wait for running pods...

- name: Wait for Pods to become ready
  shell: oc get po | grep {{ item }} | grep -v deploy | grep 1/1 > /dev/null
  delay: 20
  retries: "{{ (fs_pod_ready_timeout | int / 20) | int }}"
  register: result
  until: result.rc == 0
  loop:
  - fragnet-search
  changed_when: False

- name: Deploy application route
  k8s:
    definition: "{{ lookup('template', item)|from_yaml }}"
  loop:
  - route.yml.j2
  when: fs_enable_route|bool
