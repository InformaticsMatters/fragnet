---

# Has the user defined suitable key variables?

- name: Assert keycloak variables
  fail:
    msg: You must provide 'keycloak' variables
  when: keycloak_server_url == ''

- name: Assert graph variables
  fail:
    msg: You must provide a neo4j password
  when: graph_password == ''

- name: Assert PFX passwsord
  fail:
    msg: You must provide a PFX bundle password
  when: fragent_search_pfx_password == ''

# Start the fragnet-search container
#Â (currently on the same node as the graph DB).
# We 'always' pull the images (this is not OpenShift after all)

- name: Copy fragnet files
  copy:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}/fragnet/"
  loop:
  - fragnet-search/context.xml
  - fragnet-search/keycloak.json
  - fragnet-search/logging.properties
  - fragnet-search/web.xml

- name: Ensure logging root
  file:
    path: "{{ fragnet_search_log_root }}"
    state: directory
    mode: '0777'
  become: yes

- name: Copy fragnet templates
  template:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}/fragnet/{{ item|regex_replace('fragnet-search/')|regex_replace('.j2') }}"
  loop:
  - fragnet-search/server.xml.j2

- name: Start fragnet container ({{ image_ref }})
  docker_container:
    name: fragnet-search
    image: "{{ image_ref }}"
    pull:
      yes
    published_ports:
    - "{{ fragnet_non_ssl_port }}:8080"
    - "443:8443"
    env:
      NEO4J_SERVER: "{{ inventory_hostname }}"
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: "{{ graph_password }}"
      KEYCLOAK_SERVER_URL: "{{ keycloak_server_url }}"
      KEYCLOAK_PUBLIC_KEY: "{{ keycloak_public_key }}"
      KEYCLOAK_SECRET: "{{ keycloak_secret }}"
      LOG_ROOT: /logs
      CATALINA_OPTS: >-
        -Dkeycloak.baseurl=$KEYCLOAK_SERVER_URL
        -Dkeycloak.publickey=$KEYCLOAK_PUBLIC_KEY
        -Dkeycloak.secret=$KEYCLOAK_SECRET
    volumes:
    - "./fragnet/logging.properties:/usr/local/tomcat/conf/logging.properties:ro,Z"
    - "./fragnet/keycloak.json:/usr/local/tomcat/webapps/fragnet-search/WEB-INF/keycloak.json:ro,Z"
    - "./fragnet/web.xml:/usr/local/tomcat/webapps/fragnet-search/WEB-INF/web.xml:ro,Z"
    - "./fragnet/context.xml:/usr/local/tomcat/webapps/fragnet-search/META-INF/context.xml:ro,Z"
    - "./fragnet/server.xml:/usr/local/tomcat/conf/server.xml:ro,Z"
    - "./fragnet/bundle.pfx:/usr/local/tomcat/conf/bundle.pfx:ro,Z"
    - "{{ fragnet_search_log_root }}:/logs:Z"
    restart_policy: "{{ fragnet_restart_policy }}"
  vars:
    image_ref: squonk/fragnet-all:{{ fragnet_tag }}
  become: yes
